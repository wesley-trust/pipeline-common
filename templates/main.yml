parameters:
  - name: configuration
    type: object
    default: {}

variables:
  - ${{ each variableGroup in parameters.configuration.variableGroups }}:
      - group: ${{ variableGroup }}

stages:
  # Optional Global Initialise Stage

  - ${{ if eq(coalesce(parameters.configuration.initialise.runGlobal, true), true) }}:
      - template: stages/initialise-stage.yml@PipelineCommon
        parameters:
          environmentName: "global"
          serviceConnection: ${{ parameters.configuration.serviceConnection }}
          terraformVersion: ${{ coalesce(parameters.configuration.terraformVersion, '') }}

  # Optional Per Environment Initialise Stage

  - ${{ each env in parameters.configuration.environments }}:
      - ${{ if ne(env.skipEnvironment, true) }}:
          - ${{ if or(ne(env.class, 'production'), eq(coalesce(parameters.configuration.enableProduction, false), true)) }}:
              - ${{ if eq(coalesce(env.initialise.runPerEnvironment, false), true) }}:
                  - template: stages/initialise-stage.yml@PipelineCommon
                    parameters:
                      environmentName: ${{ env.name }}
                      serviceConnection: ${{ coalesce(env.serviceConnection, parameters.configuration.serviceConnection) }}
                      ${{ if ne(coalesce(env.pool.vmImage, env.pool.name, ''), '') }}:
                        pool: ${{ env.pool }}
                      ${{ else }}:
                        pool: ${{ parameters.configuration.defaultPool }}
                      terraformVersion: ${{ coalesce(parameters.configuration.terraformVersion, '') }}
                      dependsOnStages:
                        - ${{ if eq(coalesce(parameters.configuration.initialise.runGlobal, false), true) }}:
                            - initialise_global

  # Global Validate Stage

  - template: stages/validation-stage.yml@PipelineCommon
    parameters:
      actionGroups: ${{ parameters.configuration.actionGroups }}
      serviceConnection: ${{ parameters.configuration.serviceConnection }}
      environments: ${{ parameters.configuration.environments }}
      pool: ${{ parameters.configuration.defaultPool }}
      variableRoot: ${{ coalesce(parameters.configuration.variableRoot, 'vars') }}
      variableIncludeCommon: ${{ coalesce(parameters.configuration.variables.includeCommon, true) }}
      validation: ${{ coalesce(parameters.configuration.validation, '') }}
      customValidationScripts: ${{ parameters.configuration.customValidationScripts }}
      enableProduction: ${{ parameters.configuration.enableProduction }}
      additionalRepositories: ${{ coalesce(parameters.configuration.additionalRepositories, '') }}
      keyVault: ${{ coalesce(parameters.configuration.keyVault, '') }}

  # Environment Stages

  - ${{ each env in parameters.configuration.environments }}:
      - ${{ if ne(env.skipEnvironment, true) }}:
          - ${{ if or(ne(env.class, 'production'), eq(coalesce(parameters.configuration.enableProduction, false), true)) }}:
              ## Optional Review Stage
              - ${{ if or(eq(coalesce(parameters.configuration.runReviewStage, true), true), eq(env.class, 'production')) }}:
                  - template: stages/review-stage.yml@PipelineCommon
                    parameters:
                      environmentName: ${{ env.name }}
                      ${{ if eq(coalesce(parameters.configuration.drInvocation, false), true) }}:
                        regions:
                          - ${{ env.drRegion }}
                      ${{ elseif or(eq(coalesce(join(env.secondaryRegions, ','), ''), ''), ne(coalesce(env.runSecondaryRegions, true), true)) }}:
                        regions:
                          - ${{ env.primaryRegion }}
                      ${{ else }}:
                        regions:
                          - ${{ env.primaryRegion }}
                          - ${{ each secondaryRegion in env.secondaryRegions }}:
                              - ${{ secondaryRegion }}
                      actionGroups: ${{ parameters.configuration.actionGroups }}
                      variableRoot: ${{ coalesce(parameters.configuration.variableRoot, 'vars') }}
                      serviceConnection: ${{ coalesce(env.serviceConnection, parameters.configuration.serviceConnection) }}
                      ${{ if ne(coalesce(env.pool.vmImage, env.pool.name, ''), '') }}:
                        pool: ${{ env.pool }}
                      ${{ elseif eq(coalesce(env.pool.vmImage, env.pool.name, ''), '') }}: # Using elseif instead of else to avoid linter parsing error
                        pool: ${{ parameters.configuration.defaultPool }}
                      variableIncludeCommon: ${{ coalesce(env.variables.includeCommon, parameters.configuration.variables.includeCommon, true) }}
                      variableIncludeEnv: ${{ coalesce(env.variables.includeEnv, parameters.configuration.variables.includeEnv, true) }}
                      variableIncludeEnvRegion: ${{ coalesce(env.variables.includeEnvRegion, parameters.configuration.variables.includeEnvRegion, true) }}
                      variableIncludeRegionOnly: ${{ coalesce(env.variables.includeRegionOnly, parameters.configuration.variables.includeRegionOnly, true) }}
                      additionalRepositories: ${{ coalesce(parameters.configuration.additionalRepositories, '') }}
                      keyVault: ${{ coalesce(parameters.configuration.keyVault, '') }}
                      poolRegionDemand: ${{ coalesce(env.poolRegionDemand, false) }}
                      dependsOnStages:
                        - ${{ if ne(coalesce(env.dependsOn, ''), '') }}:
                            - ${{ env.dependsOn }}

              ## Non-DR Invocation)

              - ${{ if ne(coalesce(parameters.configuration.drInvocation, false), true) }}:
                  ### Optional Secondary Region Deployment (non DR-invocation)
                  - ${{ if eq(coalesce(env.runSecondaryRegions, true), true) }}:
                      - ${{ each secondaryRegion in env.secondaryRegions }}:
                          - template: stages/environment-region-deploy-stage.yml@PipelineCommon
                            parameters:
                              environmentName: ${{ env.name }}
                              regionName: ${{ secondaryRegion }}
                              envClass: ${{ env.class }}
                              enableProduction: ${{ coalesce(parameters.configuration.enableProduction, false) }}
                              variableRoot: ${{ coalesce(parameters.configuration.variableRoot, 'vars') }}
                              allowedBranches: ${{ env.allowedBranches }}
                              actionGroups: ${{ parameters.configuration.actionGroups }}
                              ${{ if ne(coalesce(env.pool.vmImage, env.pool.name, ''), '') }}:
                                pool: ${{ env.pool }}
                              ${{ else }}:
                                pool: ${{ parameters.configuration.defaultPool }}
                              serviceConnection: ${{ coalesce(env.serviceConnection, parameters.configuration.serviceConnection) }}
                              variableIncludeCommon: ${{ coalesce(env.variables.includeCommon, parameters.configuration.variables.includeCommon, true) }}
                              variableIncludeEnv: ${{ coalesce(env.variables.includeEnv, parameters.configuration.variables.includeEnv, true) }}
                              variableIncludeEnvRegion: ${{ coalesce(env.variables.includeEnvRegion, parameters.configuration.variables.includeEnvRegion, true) }}
                              variableIncludeRegionOnly: ${{ coalesce(env.variables.includeRegionOnly, parameters.configuration.variables.includeRegionOnly, true) }}
                              additionalRepositories: ${{ coalesce(parameters.configuration.additionalRepositories, '') }}
                              keyVault: ${{ coalesce(parameters.configuration.keyVault, '') }}
                              poolRegionDemand: ${{ coalesce(env.poolRegionDemand, false) }}
                              dependsOnStages:
                                - ${{ if or(eq(coalesce(parameters.configuration.runReviewStage, true), true), eq(env.class, 'production')) }}:
                                    - review_${{ env.name }}
                                - ${{ if ne(coalesce(env.dependsOn, ''), '') }}:
                                    - ${{ env.dependsOn }}
                              bicepModeOverride: ${{ parameters.configuration.bicepModeOverride }}

                  ### Primary Region Deployment (non DR-invocation)

                  - template: stages/environment-region-deploy-stage.yml@PipelineCommon
                    parameters:
                      environmentName: ${{ env.name }}
                      regionName: ${{ env.primaryRegion }}
                      envClass: ${{ env.class }}
                      enableProduction: ${{ coalesce(parameters.configuration.enableProduction, false) }}
                      variableRoot: ${{ coalesce(parameters.configuration.variableRoot, 'vars') }}
                      allowedBranches: ${{ env.allowedBranches }}
                      actionGroups: ${{ parameters.configuration.actionGroups }}
                      ${{ if ne(coalesce(env.pool.vmImage, env.pool.name, ''), '') }}:
                        pool: ${{ env.pool }}
                      ${{ else }}:
                        pool: ${{ parameters.configuration.defaultPool }}
                      serviceConnection: ${{ coalesce(env.serviceConnection, parameters.configuration.serviceConnection) }}
                      variableIncludeCommon: ${{ coalesce(env.variables.includeCommon, parameters.configuration.variables.includeCommon, true) }}
                      variableIncludeEnv: ${{ coalesce(env.variables.includeEnv, parameters.configuration.variables.includeEnv, true) }}
                      variableIncludeEnvRegion: ${{ coalesce(env.variables.includeEnvRegion, parameters.configuration.variables.includeEnvRegion, true) }}
                      variableIncludeRegionOnly: ${{ coalesce(env.variables.includeRegionOnly, parameters.configuration.variables.includeRegionOnly, true) }}
                      additionalRepositories: ${{ coalesce(parameters.configuration.additionalRepositories, '') }}
                      keyVault: ${{ coalesce(parameters.configuration.keyVault, '') }}
                      poolRegionDemand: ${{ coalesce(env.poolRegionDemand, false) }}
                      dependsOnStages:
                        - ${{ if or(eq(coalesce(parameters.configuration.runReviewStage, true), true), eq(env.class, 'production')) }}:
                            - review_${{ env.name }}
                        - ${{ if ne(coalesce(env.dependsOn, ''), '') }}:
                            - ${{ env.dependsOn }}
                        - ${{ if and(eq(coalesce(env.dependsOnSecondaryRegions, false), true), eq(coalesce(env.runSecondaryRegions, true), true)) }}:
                            - ${{ each secondaryRegion in env.secondaryRegions }}:
                                - deploy_${{ env.name }}_${{ secondaryRegion }}
                      bicepModeOverride: ${{ parameters.configuration.bicepModeOverride }}

              ## DR Invocation)

              - ${{ if eq(coalesce(parameters.configuration.drInvocation, false), true) }}:
                  - ${{ if or(ne(env.class, 'production'), eq(coalesce(parameters.configuration.enableProduction, false), true)) }}:
                      - template: stages/environment-region-deploy-stage.yml@PipelineCommon
                        parameters:
                          environmentName: ${{ env.name }}
                          regionName: ${{ coalesce(env.drRegion, env.primaryRegion) }}
                          envClass: ${{ env.class }}
                          enableProduction: ${{ coalesce(parameters.configuration.enableProduction, false) }}
                          variableRoot: ${{ coalesce(parameters.configuration.variableRoot, 'vars') }}
                          allowedBranches: ${{ env.allowedBranches }}
                          actionGroups: ${{ parameters.configuration.actionGroups }}
                          ${{ if ne(coalesce(env.pool.vmImage, env.pool.name, ''), '') }}:
                            pool: ${{ env.pool }}
                          ${{ else }}:
                            pool: ${{ parameters.configuration.defaultPool }}
                          serviceConnection: ${{ coalesce(env.serviceConnection, parameters.configuration.serviceConnection) }}
                          variableIncludeCommon: ${{ coalesce(env.variables.includeCommon, parameters.configuration.variables.includeCommon, true) }}
                          variableIncludeEnv: ${{ coalesce(env.variables.includeEnv, parameters.configuration.variables.includeEnv, true) }}
                          variableIncludeEnvRegion: ${{ coalesce(env.variables.includeEnvRegion, parameters.configuration.variables.includeEnvRegion, true) }}
                          variableIncludeRegionOnly: ${{ coalesce(env.variables.includeRegionOnly, parameters.configuration.variables.includeRegionOnly, true) }}
                          additionalRepositories: ${{ coalesce(parameters.configuration.additionalRepositories, '') }}
                          keyVault: ${{ coalesce(parameters.configuration.keyVault, '') }}
                          poolRegionDemand: ${{ coalesce(env.poolRegionDemand, false) }}
                          dependsOnStages:
                            - ${{ if or(eq(coalesce(parameters.configuration.runReviewStage, true), true), eq(env.class, 'production')) }}:
                                - review_${{ env.name }}
                            - ${{ if ne(coalesce(env.dependsOn, ''), '') }}:
                                - ${{ env.dependsOn }}
                          bicepModeOverride: ${{ parameters.configuration.bicepModeOverride }}
