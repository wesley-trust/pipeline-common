parameters:
  - name: actionGroups
    type: object
    default: []
  - name: pool
    type: object
    default: {}
  - name: dependsOnStages
    type: object
    default: []
  - name: additionalRepositories
    type: object
    default: []
  - name: keyVault
    type: object
    default: {}
  - name: serviceConnection
    type: string
    default: ""
  - name: useLockedSources
    type: boolean
    default: true

jobs:
  - job: validate_token_targets
    displayName: Validate Token Targets
    dependsOn: ${{ parameters.dependsOnStages }}
    steps:
      - checkout: PipelineCommon
        path: s/PipelineCommon
      - ${{ if eq(parameters.useLockedSources, true) }}:
          - template: ../../steps/download-artifact.yml@PipelineCommon
            parameters:
              displayName: Download source snapshot
              artifactName: source-snapshot
              downloadPath: $(Pipeline.Workspace)/s/self
      - ${{ if eq(parameters.useLockedSources, false) }}:
          - checkout: self
            path: s/self
      - ${{ if ne(coalesce(parameters.additionalRepositories, ''), '') }}:
          - ${{ each repo in parameters.additionalRepositories }}:
              - checkout: ${{ repo.alias }}
      - ${{ each actionGroup in parameters.actionGroups }}:
          - ${{ if ne(coalesce(actionGroup.actions, ''), '') }}:
              - ${{ if ne(actionGroup.enabled, false) }}:
                  - ${{ each action in actionGroup.actions }}:
                      - ${{ if ne(action.enabled, false) }}:
                          - ${{ if ne(coalesce(action.tokenTargetPatterns, ''), '') }}:
                              - template: ../../steps/powershell.yml@PipelineCommon
                                parameters:
                                  displayName: Validate token patterns (${{ coalesce(action.displayName, upper(replace(coalesce(action.name, 'ACTION'), '_', ' '))) }})
                                  repoAlias: PipelineCommon
                                  script: validate_token_targets.ps1
                                  arguments: >-
                                    -RootPath "$(Pipeline.Workspace)/s/self"
                                    -Patterns @('${{ join(action.tokenTargetPatterns, ''',''') }}')
      - ${{ if ne(coalesce(parameters.keyVault.name, ''), '') }}:
          - template: ../../steps/import-keyvault-secrets.yml@PipelineCommon
            parameters:
              displayName: Import Key Vault Secrets
              azureSubscription: ${{ coalesce(variables[parameters.serviceConnection], parameters.serviceConnection) }}
              keyVaultName: ${{ parameters.keyVault.name }}
              secretsFilter: ${{ coalesce(parameters.keyVault.secretsFilter, '*') }}
