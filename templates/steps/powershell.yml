parameters:
  - name: displayName
    type: string
    default: PowerShell
  - name: repoAlias
    type: string
    default: PipelineCommon
  - name: script
    type: string
    default: ""
  - name: scriptFullPath
    type: string
    default: ""
  - name: arguments
    type: string
    default: ""
  - name: workingDirectory
    type: string
    default: ""
  - name: pwsh
    type: boolean
    default: true
  - name: condition
    type: string
    default: ""
  - name: scriptTask
    type: string
    default: pwsh
  - name: azureSubscription
    type: string
    default: ""
  - name: addSpnToEnvironment
    type: boolean
    default: false
  - name: azurePowerShellVersion
    type: string
    default: LatestVersion

steps:
  - ${{ if eq(lower(parameters.scriptTask), 'azurecli') }}:
      - template: azurecli.yml@PipelineCommon
        parameters:
          displayName: ${{ parameters.displayName }}
          azureSubscription: ${{ parameters.azureSubscription }}
          repoAlias: ${{ parameters.repoAlias }}
          ${{ if ne(parameters.scriptFullPath, '') }}:
            scriptFullPath: ${{ parameters.scriptFullPath }}
          ${{ if and(eq(parameters.scriptFullPath, ''), ne(parameters.script, '')) }}:
            script: ${{ parameters.script }}
          arguments: ${{ parameters.arguments }}
          workingDirectory: ${{ parameters.workingDirectory }}
          condition: ${{ parameters.condition }}
          addSpnToEnvironment: ${{ parameters.addSpnToEnvironment }}
  - ${{ if eq(lower(parameters.scriptTask), 'azurepowershell') }}:
      - task: AzurePowerShell@5
        displayName: ${{ parameters.displayName }}
        inputs:
          ScriptType: FilePath
          ${{ if ne(parameters.scriptFullPath, '') }}:
            ScriptPath: ${{ parameters.scriptFullPath }}
          ${{ if and(eq(parameters.scriptFullPath, ''), ne(parameters.script, '')) }}:
            ScriptPath: $(Build.SourcesDirectory)/${{ parameters.repoAlias }}/scripts/${{ parameters.script }}
          ${{ if ne(parameters.arguments, '') }}:
            ScriptArguments: ${{ parameters.arguments }}
          ${{ if ne(parameters.workingDirectory, '') }}:
            ScriptDirectory: ${{ parameters.workingDirectory }}
          azurePowerShellVersion: ${{ parameters.azurePowerShellVersion }}
          pwsh: true
          ${{ if ne(parameters.azureSubscription, '') }}:
            azureSubscription: ${{ parameters.azureSubscription }}
        ${{ if ne(parameters.condition, '') }}:
          condition: ${{ parameters.condition }}
  - ${{ if not(or(eq(lower(parameters.scriptTask), 'azurecli'), eq(lower(parameters.scriptTask), 'azurepowershell'))) }}:
      - task: PowerShell@2
        displayName: ${{ parameters.displayName }}
        inputs:
          pwsh: ${{ parameters.pwsh }}
          targetType: filePath
          ${{ if ne(parameters.scriptFullPath, '') }}:
            filePath: ${{ parameters.scriptFullPath }}
          ${{ if and(eq(parameters.scriptFullPath, ''), ne(parameters.script, '')) }}:
            filePath: $(Build.SourcesDirectory)/scripts/${{ parameters.script }}
          ${{ if ne(parameters.arguments, '') }}:
            arguments: "${{ parameters.arguments }}"
          ${{ if ne(parameters.workingDirectory, '') }}:
            workingDirectory: ${{ parameters.workingDirectory }}
        ${{ if ne(parameters.condition, '') }}:
          condition: ${{ parameters.condition }}
